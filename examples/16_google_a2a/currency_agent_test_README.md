# LangGraph Agent A2A协议交互测试

## 概述

本测试脚本 (`examples/a2a/currency_agent_test.py`) 旨在通过具体的交互场景，测试和演示如何使用 A2A 客户端与先前通过 `langgraph_integration.py` 启动的 LangGraph Agent 服务进行通信。它覆盖了同步请求（涉及工具调用）、尝试进行多轮对话以及接收（模拟的）流式响应等场景。

## 测试场景说明

此脚本包含以下三个主要测试场景：

1.  **场景 1: 同步请求 - Agent 调用 (涉及工具)**
    * **目的:** 测试发送一个需要 Agent 调用内部工具（如此示例中的计算器）才能完成的请求。
    * **流程:** 客户端发送一个计算任务 -> 服务器端 Agent (LangGraph ReAct) 解析任务 -> 调用 `calculator` 工具 -> 获取结果 -> LLM 整合答案 -> 服务器返回最终结果 -> 客户端轮询获取并显示结果。
    * **预期:** 客户端能成功获取到 Agent 计算后的准确结果。

2.  **场景 2: 多轮对话尝试 (Agent 当前实现有限)**
    * **目的:** 测试客户端在需要多步交互时的请求发送方式（使用 `sessionId`），并观察当前 Agent 的响应行为。
    * **流程:**
        * 第一轮：客户端发送一个信息不明确的查询（例如 "100美元等于多少"，缺少目标货币），并附带 `sessionId`。
        * 客户端轮询获取结果。
        * **注意:** *根据我们当前的 Agent 实现 (`CurrencyAgent` 使用 `create_react_agent` 且 `invoke` 未特殊处理对话历史)，Agent 很可能不会返回 `input-required` 状态来请求更多信息，而是会直接尝试处理或告知无法处理，然后将任务标记为 `completed` 或 `failed`。*
        * (理想流程中，如果 Agent 返回 `input-required`，客户端会发送第二轮请求补充信息，使用相同的 `sessionId`。)
    * **预期:** 客户端能够正确发送带 `sessionId` 的请求，并能处理 Agent 的最终响应（即使它没有按预期进入多轮澄清状态）。此测试主要验证客户端的多轮请求发送能力和对 Agent 当前行为的观察。

3.  **场景 3: 流式响应 (Agent 端模拟)**
    * **目的:** 测试客户端接收 A2A 流式响应 (Server-Sent Events) 的能力。
    * **流程:** 客户端发送一个适合流式输出的查询 -> 服务器端的 `AgentTaskManager` 调用 `CurrencyAgent.stream` 方法 -> **注意:** *`CurrencyAgent.stream` 当前是一个模拟实现，它会发送预设的文本块，而不是真正调用 LangGraph 的流式接口。* -> 客户端接收并打印这些模拟的流式事件。
    * **预期:** 客户端能够成功连接 SSE 端点，并接收、打印服务器发送的（模拟）流式事件。

## 运行测试

### 前提条件

* Python (推荐 3.10 或更高版本)
* 已根据项目 `requirements.txt` 安装所有必需的 Python 依赖库。
* 在项目根目录下的 `.env` 文件中配置了有效的 `OPENAI_API_KEY` (或其他所需的 LLM API 密钥)。

### 步骤

1.  **启动 A2A 服务器:**
    * 确保你位于项目的根目录。
    * 在终端中运行 (如果尚未运行):
        ```bash
        python -m examples.a2a.langgraph_integration
        ```
    * 服务器应成功启动并监听在 `http://127.0.0.1:8000`。

2.  **运行本测试脚本:**
    * 打开 **另一个** 终端。
    * 确保你位于项目的根目录并激活了相同的虚拟环境。
    * 运行测试脚本:
        ```bash
        python -m examples.a2a.currency_agent_test
        ```

## 测试输出示例 (基于实际运行结果)

以下是运行此测试脚本时预期的输出格式，反映了当前 Agent 的实际行为：

### 同步请求示例 (计算器调用)

```
=== 测试场景1: 同步请求 - Agent 调用 (计算器) ===

任务已发送，ID: test_sync_...
等待任务完成...
  当前任务状态: completed
任务成功完成。结果:
  - 58 * 34 的结果是 1972。
```

### 多轮对话示例 (Agent 第一轮即完成)

```
=== 测试场景2: 多轮对话 (Agent 可能不支持) ===
注意：当前服务器端的 Agent 实现可能不支持真正的多轮状态保持。

第一轮对话 (Session: test_session_multi_...): 发送 '100美元等于多少'
第一轮任务已发送，ID: test_multi_1_...
等待第一轮任务响应...
  当前任务状态: completed
Agent 在第一轮就已完成任务 (可能直接使用了默认货币或无法处理):
  - 目前无法提供100美元等于多少人民币的具体信息。你可以查阅最新的汇率数据或使用汇率转换工具来获取准确的结果。
```
*(注意：Agent 的具体回复可能因 LLM 的不同调用而略有差异)*

### 流式响应示例 (Agent 端模拟)

```
=== 测试场景3: 流式响应 (Agent 端为模拟) ===

任务已发送，ID: test_stream_...
开始接收流式响应:
  流式更新: 正在处理您的请求...
  流式结果: 关于 '用中文写一首关于春天的短诗' 的信息如下：这是一个模拟的回应，因为真实流未实现。
流式响应结束标志收到。
流式任务处理完成。
```

## 注意事项

* 确保在运行测试前已正确设置 `.env` 文件中的环境变量。
* 测试脚本默认连接 `http://127.0.0.1:8000`。如果服务器地址或端口不同，请修改脚本中的 `A2AClient` 初始化 URL。
* 如果连接失败或测试出错，请优先检查 A2A 服务器是否已正确启动且正在运行，并查看服务器端的日志输出。

---

## 两个客户端示例的命名与区别

你项目中有两个客户端示例文件，我们可以为它们命名并说明其侧重点：

1.  **`examples/a2a/client_example.py` -> "基础客户端示例 (Basic Client Example)"**
    * **目的:** 这个脚本更侧重于**基础演示**，展示了调用 `A2AClient` 库中几个核心方法（`send_task`, `get_task`, `send_task_streaming`）的最基本用法。
    * **特点:** 代码相对简洁，逻辑直接，主要目的是让使用者快速了解如何发起不同类型的 A2A 请求并处理最简单的成功响应。它包含了一个简单的轮询逻辑。

2.  **`examples/a2a/currency_agent_test.py` -> "场景化测试客户端 (Scenario-based Test Client)"**
    * **目的:** 这个脚本的定位是**功能测试和场景演示**。它针对我们集成的 LangGraph Agent 设计了几个具体的交互场景（同步工具调用、尝试多轮对话、流式接收），以验证端到端的流程和观察 Agent 在特定情况下的行为。
    * **特点:** 结构更清晰地划分为不同的测试函数，包含了更具体的业务逻辑查询（尽管有些是模拟的或揭示了 Agent 的局限性），并且其输出更侧重于展示每个测试场景的结果。它也使用了轮询，并尝试了多轮交互的状态传递（通过 `sessionId`）。

**主要区别总结:**

| 特性         | `client_example.py` (基础示例)                 | `currency_agent_test.py` (场景化测试)                 |
| :----------- | :--------------------------------------------- | :---------------------------------------------------- |
| **目标** | 演示 Client API 基本用法                       | 测试/演示特定交互场景                                 |
| **结构** | 简单的顺序调用                                 | 按测试场景划分函数                                    |
| **复杂度** | 较低，核心 API 调用                            | 略高，包含场景逻辑（如尝试多轮）                      |
| **查询内容** | 通用示例（计算、搜索）                         | 针对场景设计（计算、不完整查询、适合流式的查询）        |
| **侧重点** | 如何调用 API                                   | Agent 在特定场景下的行为和端到端流程验证              |
